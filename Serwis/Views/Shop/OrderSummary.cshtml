@using Microsoft.AspNetCore.Http;
@model Serwis.Models.ViewModels.OrderViewModel;
@inject IHttpContextAccessor HttpContextAccessor;
@{
    var sessionForUserEmail = HttpContextAccessor.HttpContext?.Session.GetString("Email");
}

<div class="container border" style="padding:20px">



    @*@foreach(var pos in test)
    {
    <div form-group row>
    <div class=" col-6">
    <input readonly type="text" value="@pos" class="form-control">
    </div>

    </div>
    }*@

    <div class=" border">

        <label style="font-weight: bold;" class="col-1 offset-1 text-center">Ilość</label><label class="col-1 offset-1"></label> <label style="font-weight: bold;" class="col-3 text-center">Nazwa</label><label class="col-1"></label> <label style="font-weight: bold;" text-center">Produkt</label>
        <label class="col-12"></label>
        @foreach (var pos in Model.OrderPositions)
        {
            //var maciek = Model.OrderPositions.Where(x => x.ProductId == pos.ProductId).Select(x => x.Product.Name);

            <div form-group>
                <div style="padding:2px">
                    <label class="col-1 offset-1 text-center">@pos.Quantity</label> <label class="text-center col-1 offset-1"> X </label> <label class="col-3 text-center">@pos.Product.Name</label> <label class="col-1 offset-"></label><img style="width:75px; height: 50px;" src="~/images/@pos.Product.ImageFileName" />
                </div>
            </div>
        }
    </div>

    <div style="padding:2px" class="border-1">
        <div form-group row>
            <div class="col-5 mt-1">
                <label style="font-weight: bold;" asp-for="Title"></label> <!--wazne aby własciwosci mialy odpowiedni poziom dostepu-->
            </div>
            <div>
                <label class="col-5 mt-1">@Model.Title </label>
            </div>
        </div>
        <div form-group row>
            <div class="col-5 mt-1">
                <label style="font-weight: bold;" asp-for="FullPrice"></label> <!--wazne aby własciwosci mialy odpowiedni poziom dostepu-->
            </div>
            <div class=" mt-1">
                <label class="col-5 mt-1">@Model.FullPrice zł</label>
            </div>
        </div>
        <div form-group row>
            <div class="col-5 mt-1">
                <label style="font-weight: bold;">Mail</label> <!--wazne aby własciwosci mialy odpowiedni poziom dostepu-->
            </div>
            <div class=" mt-1 col-7">
                <input type="text" id="email" value="@sessionForUserEmail" class="form-control">
            </div>
        </div>
    </div>

</div>
<div form-group row>
    <div class=" mt-1 col-6">
        <button onclick="ConfirmInvoiceOrder()"
                value="Kupuję"
                class="btn btn-primary mt-3  form-control">
            Kupuję
        </button>
    </div>
    <div class=" col-6">
        <a type="button" class="btn btn-secondary form-control mt-1" asp-action="Index" asp-controller="Admin">Rezygnuję</a>
    </div>
</div>

@section scripts{
    <script type="text/javascript">


        let testVal = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;

        let email;


        function ValidateEmail(email)
        {
            if ((testVal.test(email))===true) {
               toastr.success("Poprawne dane");
            } else {
                toastr.error("Email jest niepoprawny");
            }
        }

        function ConfirmInvoiceOrder(productId, userId, orderId, email) {
            email = document.getElementById("email").value;
            ValidateEmail(email)
            return;
            if (!confirm("test"))
                return;

            $.ajax({
                type: "post",
                url: "@Url.Action("OrderSummary","Shop")",
                data: {
                    productId: productId,
                    userId: userId,
                    orderId: orderId,
                    email: email
                },
                success: function(data) {
                    if (data.success) {
                        toastr.success("Gratuluje zakupu!")
                    } else {
                        toastr.error("Niestety coś poszło nie tak :(")

                    }
                },
                dataType: "json"
            });
        }

    </script>
    }
