@using Microsoft.AspNetCore.Http;
@model Serwis.Models.ViewModels.OrderViewModel;
@inject IHttpContextAccessor HttpContextAccessor;
@{
    var sessionForUserEmail = HttpContextAccessor.HttpContext?.Session.GetString("Email");
}

<section class="container" style="padding:20px" id="summary_display">
    <article id="products_list">

        <label style="font-weight: bold;" class="col-1 offset-1 text-center">Ilość</label><label class="col-1 offset-1"></label> <label style="font-weight: bold;" class="col-3 text-center">Nazwa</label><label class="col-1"></label> <label style="font-weight: bold;" text-center">Produkt</label>
        <label class="col-12"></label>
        @foreach (var pos in Model.OrderPositions)
        {
            //var maciek = Model.OrderPositions.Where(x => x.ProductId == pos.ProductId).Select(x => x.Product.Name);

            <aside form-group style="padding:2px">
                <label class="col-1 offset-1 text-center">@pos.Quantity</label>
                <label class="text-center col-1 offset-1"> X </label>
                <label class="col-3 text-center">@pos.Product.Name</label>
                <label class="col-1 offset-"></label>
                <img style="width:50px; height: 75px;" src="~/images/@pos.Product.ImageFileName" />
            </aside>
        }
    </article>

    <article style="padding:2px" class="border-1">
        <aside form-group row>
            <div class="col-5 mt-1">
                <label style="font-weight: bold;" asp-for="Title"></label> <!--wazne aby własciwosci mialy odpowiedni poziom dostepu-->
            </div>
            <div>
                <label class="col-5 mt-1">@Model.Title </label>
            </div>
        </aside>
        <aside form-group row>
            <div class="col-5 mt-1">
                <label style="font-weight: bold;" asp-for="FullPrice"></label> <!--wazne aby własciwosci mialy odpowiedni poziom dostepu-->
            </div>
            <div class=" mt-1">
                <label class="col-5 mt-1">@Model.FullPrice zł</label>
            </div>
        </aside>
        <aside form-group row>
            <div class="col-5 mt-1">
                <label style="font-weight: bold;">Mail</label> <!--wazne aby własciwosci mialy odpowiedni poziom dostepu-->
            </div>
            <div class=" mt-1 col-7">
                <input type="text" id="email" value="@sessionForUserEmail" class="form-control">
            </div>
        </aside>
    </article>


    <article id="accept_back">
        <aside class=" mt-1 col-6">
            <button onclick="ConfirmInvoiceOrder()"
                    value="Kupuję"
                    class="btn btn-dark mt-3  form-control">
                Kupuję
            </button>
        </aside>
        <aside class=" col-6">
            <a type="button" class="btn btn-light form-control mt-1" asp-action="Index" asp-controller="Shop">Rezygnuję</a>
        </aside>
    </article>
    <article id="back">
        <aside class="col-6">
            <a type="button" class="btn btn-light form-control mt-1" asp-action="Index" asp-controller="Shop">Powrót</a>
        </aside>
    </article>
</section>

@section scripts{
    <script type="text/javascript">

        $(document).ready(function() {
            $('#back').css("display", "none");

        });
        let testVal = /(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9]))\.){3}(?:(2(5[0-5]|[0-4][0-9])|1[0-9][0-9]|[1-9]?[0-9])|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])/;

        let email;

        function ConfirmInvoiceOrder(email) {
            email = document.getElementById("email").value;

            if ((testVal.test(email)) === true) {


            } else {
                toastr.error("Email jest niepoprawny");
                return;
            }

            $.ajax({
                type: "post",
                url: "@Url.Action("OrderSummary","Shop")",
                data: {
                    email: email
                },
                success: function(data) {
                    if (data.success) {
                        toastr.success("Gratuluje zakupu!")
                        $('#back').css("display", "");
                        $('#accept_back').css("display", "none");
                        sessionStorage.removeItem('key');

                        document.cookie = 'cart =; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';


                        document.getElementsByClassName('cart-quantity')[0].textContent = 0;

                    } else {
                        toastr.error("Niestety coś poszło nie tak :(")
                    }
                },
                dataType: "json"
            });
        }

    </script>
    }
