@using Serwis.Models.Domains
@model Serwis.Models.ViewModels.ProductViewModel

@{
    ProductCategory category = null;
    var productCategoryId = Model.CategoryId;
    if (productCategoryId != 0)
    {
        category = Model.CategoriesList.Single(x => x.Id == productCategoryId);
    }
}
<section class="container row">
    <article class="col-6">
        <aside>
            <h2>@(Model.Id == 0 ? "Dodawanie nowego produktu" : "Aktualizowanie produktu")</h2>
        </aside>
        <form method="post" asp-action="Upsert" asp-controller="Admin" enctype="multipart/form-data">

            @if (Model.Id != 0)
            {
                <input type="hidden" asp-for="Id">
                <input type="hidden" asp-for="ImageFileName" value="@Model.ImageFileName">
            }

            <div class="text-danger" asp-validation-summary="ModelOnly"></div>
            <article class="form-group row mt-3">
                <aside class="col-3">
                    <label asp-for="Name"></label>
                </aside>
                <aside class="col-6 offset-3">
                    <input class="form-control" asp-for="Name">
                </aside>
                <span class="text-danger" asp-validation-for="Name"></span>
            </article>

            <article class="form-group row mt-3">
                <aside class="col-3">
                    <label asp-for="ImageFile"></label>
                </aside>
                <aside class="col-6 offset-3">
                    <input id="imageFile" class="form-control" accept="image/*" asp-for="ImageFile">
                    @if (@Model.ImageFileName == null)
                    {
                        <div id="preview" class="mt-3">
                            <p>Nie wybrano żadnego zdjecia</p>
                        </div>
                    }
                </aside>

                <span class="text-danger" asp-validation-for="ImageFile"></span>
            </article>
            <article class="form-group row mt-3">
                <aside class="col-3">
                    <label asp-for="Description"></label>
                </aside>
                <aside class="col-6 offset-3">
                    <textarea class="form-control" rows="3" asp-for="Description"></textarea>
                </aside>
                <span class="text-danger" asp-validation-for="Description"></span>
            </article>
            <article class="form-group row mt-3">
                <aside class="col-3">
                    <label asp-for="Price"></label>
                </aside>
                <aside class="col-6 offset-3">
                    <input id="price" class="form-control" asp-for="Price">
                </aside>
                <span class="text-danger" asp-validation-for="Price"></span>
            </article>
            <article class="form-group row mt-3">
                <aside class="col-3">
                    <label asp-for="CategoryId"></label>
                </aside>
                <aside class="col-6 offset-3">
                    <select class="form-control" style="cursor:pointer"
                            asp-for="CategoryId"
                            asp-items="@(new SelectList(Model.CategoriesList, "Id", "Name"))">
                        @if (Model.Id == 0)
                        {
                            <option value="">Wybierz rodzaj ostrości</option>
                        }
                        else
                        {
                            <option value="@category.Name">Wybierz rodzaj ostrości</option>

                        }
                    </select>

                </aside>
                <span class="text-danger" asp-validation-for="CategoryId"></span>

            </article>

            <article class="form-group row mt-3">
                <aside class="col-3 offset-6 ">
                    <input id="submit_btn" type="submit" class=" btn btn-dark form-control" value="Zatwierdź" />
                </aside>
                <aside class="col-3">
                    <a type="button" class="btn btn-light form-control" asp-action="Service">Powrót</a>
                </aside>
            </article>
        </form>

    </article>
    <article class="col-5 offset-1">
        @if (@Model.ImageFileName != null)
        {
            <h5 class="m-2">Podgląd zdjęcia</h5>
            <img class="mt-3" style="height:500px; width:280px;" src="~/images/@Model.ImageFileName" />
        }
    </article>
</section>
@section scripts{
    <partial name="_validationScriptsPartial" />
    <script type="text/javascript">
        let price = document.getElementById('price');
const input = document.getElementById('imageFile');
const preview = document.getElementById('preview');

//input.style.opacity = 0;


input.addEventListener('change', updateImageDisplay); // oczekiwanie na zmiane i wtedy wywołanie
function updateImageDisplay() {
    while (preview.firstChild) {
        preview.removeChild(preview.firstChild); //oczyszczenie z poprzedniego widoku
    }

    const curFiles = input.files;
    if (curFiles.length === 0) { // w momencie gdy niczego nie zaznaczono
        const para = document.createElement('p');
        para.textContent = 'Nie wybrałeś żadnego elementu';
        preview.appendChild(para); //wyswietlenie błedu
    } else {
        for (const file of curFiles) {
            const para = document.createElement('p');
            if (validFileType(file)) {//jesli format jest odpowiedni
                const image = document.createElement('img'); //stworzenie znacznika img
                image.src = URL.createObjectURL(file); //pobranie zrodla zdjecia
                preview.appendChild(image);
            } else {
                para.textContent = `Plik ${file.name}: nie jest odpowiedniego typu!`;
                para.style.color = 'rgb(255, 0, 0)';
                preview.appendChild(para);
            }

            list.appendChild(listItem);
        }
    }
}
const fileTypes = [
    "image/apng",
    "image/bmp",
    "image/gif",
    "image/jpeg",
    "image/pjpeg",
    "image/png",
    "image/svg+xml",
    "image/tiff",
    "image/webp",
    "image/x-icon"
];

function validFileType(file) {
    return fileTypes.includes(file.type);
}
       

    </script>
}